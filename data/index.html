<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content='width=device-width;text/html;initial-scale=1' http-equiv="Content-Type" />
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
<style>
  div.hidden {display:none;}
</style>
<script>
  function do_fetch(pathname, params=null, kws=null) {
    var origin = window.location.origin;
    // https://developer.mozilla.org/zh-CN/docs/Web/API/URL
    if (origin.startsWith('file')) {
      return;
    }
    var url = new URL(pathname, origin);
    if (params == null) {
      params = [];
    }
    for (let i in params) {
      var k = params[i];
      // https://developer.mozilla.org/zh-CN/docs/Web/API/Document/getElementById
      var e = document.getElementById(k);
      if (e == null) {
        e = document.getElementsByName(k)[0];
      }
      var v = e.value;
      // https://code-boxx.com/javascript-fetch-get-query-params/
      url.searchParams.append(k, v);
    }
    if (kws == null) {
      kws = {}
    }
    for (let k in kws) {
      url.searchParams.append(k, kws[k]);
    }
    return fetch(url).then((response) => {
      if (!response.ok) {
        return response.text().then((text) => alert(text))
      }
      return response;
    });
  }

  function unload() {
    do_fetch('/unload', ['previous_extruder'])
  }
  function load() {
    do_fetch('/load', ['next_extruder'])
  }
  function stop() {
    do_fetch('/stop', ['servo1_init', 'servo_power', 'previous_extruder', 'next_extruder'])
  }
  function test_forward() {
    do_fetch('/test_forward', ['next_extruder'])
  }
  function test_backward() {
    do_fetch('/test_backward', ['previous_extruder'])
  }
  function get_config() {
    do_fetch('/get_config')
      .then((response) => response.json())
      .then((data) => {
        for (let k in data) {
          var e = document.getElementsByName(k)[0];
          if (e) {
            e.value = data[k];
          }
        }
      });
  }
  function get_local_ip() {
    do_fetch('/get_local_ip')
      .then((response) => response.json())
      .then((data) => {
        var e = document.getElementById("local_ip");
        e.href = "http://" + data["local_ip"];
        e.text = data["local_ip"];
      })
  }
  function on_load() {
    get_config();
  }
  window.addEventListener('load', on_load);
</script>
<script>
  function mode_change() {
    var mode = document.getElementsByName('mode')[0].value;
    if (mode == "WAN") {
      document.getElementById('LAN').setAttribute("class", "hidden");
      document.getElementById('WAN').setAttribute("class", "");
    } else if (mode == "LAN"){
      document.getElementById('LAN').setAttribute("class", "");
      document.getElementById('WAN').setAttribute("class", "hidden");
    }
  }
</script>

<div style="width:400px;float:left;">
  <button data-bs-toggle="collapse" data-bs-target="#config">
    ç¼–å†™é…ç½®ğŸ”½
  </button>
  <div class="collapse show" id="config" aria-expanded="true">
    <form action="/put_config" target="stop">
    WiFiåç§°ï¼š<input name="WiFi_ssid"> <br>
    WiFiå¯†ç ï¼š<input name="WiFi_passphrase"> <br>
    è¯·é€‰æ‹©è”æœºæ¨¡å¼: 
    <select name="mode" onchange=mode_change()>
      <option value="WAN">å¹¿åŸŸç½‘æ¨¡å¼</option>
      <option value="LAN">å±€åŸŸç½‘æ¨¡å¼</option>
    </select>
    <br>
    <div id="LAN" class="hidden">
      æ‰“å°æœºipåœ°å€ï¼š<input name="bambu_mqtt_broker"> <br>
      æ‰“å°æœºè®¿é—®ç ï¼š<input name="bambu_mqtt_password"> <br>
    </div>
    <div id="WAN">
      æ‰‹æœºå·ç ï¼š<input name="phone_number"> <br>
      å¯†ç ï¼š<input name="password"> <br>
    </div>
    æ‰“å°æœºåºåˆ—å·ï¼š<input name="bambu_device_serial"> <br>
    èˆµæœºçš„åˆå§‹è§’åº¦: <input type='number' name='servo1_init' value=90> <br>
    èˆµæœºçš„åŠ›åº¦: <input type='number' name='servo_power' value=30> <br>
    <input type="submit" value="æäº¤é…ç½®"> <br>
    </form>
    <!-- ä»¥ä¸‹ç”¨äºç¦æ­¢æäº¤ä¿¡æ¯åçš„é¡µé¢è·³è½¬ -->
    <iframe  name="stop" style="display:none;"></iframe>
  </div>
-------------------------------------------------- <br>
æœ‰å¾…é€€æ–™ç®¡é“ï¼š<input type='number' name='previous_extruder' value=0> <br>
æœ‰å¾…è¿›æ–™ç®¡é“ï¼š<input type='number' name='next_extruder' value=0> <br>
<button onmouseup=unload()>unload</button>
<button onmouseup=load()>load</button>
<button onmouseup=stop()>stop</button> <br>
<button onmouseup=fetch('/resume')>resume</button>
<button onmouseup=fetch('/gcode_m109')>gcode_m109</button> <br>
<button onmouseup=test_forward()>test_forward</button>
<button onmouseup=test_backward()>test_backward</button> <br>
<button onmouseup=fetch('/restart')>é‡å¯</button> <br>
<button onmouseup=get_local_ip()>è·å– ip</button> <br>
è·³è½¬åˆ°ï¼š<a id="local_ip"></a> <br>
</div>

<div style="float:left;">
  <table>
    <tr>
      <td>sequence_id:</td>
      <td id="sequence_id">unknown</td>
    </tr>
    <tr>
      <td>
        hw_switch_state<span data-bs-toggle=tooltip data-bs-html=true title="æ–™çº¿æ£€æµ‹<br>1ï¼šæ­£å¸¸<br>0ï¼šæ— æ–™">â”</span>:
      </td>
      <td id="hw_switch_state">unknown</td>
    </tr>
    <tr>
      <td>
        ams_status<span data-bs-toggle="tooltip" data-bs-html=true title="258ï¼šåŠ çƒ­å–·å˜´<br>
          259ï¼šå‰ªæ–­è€—æä¸<br>
          260:é€€æ–™æœ€åæç¤ºå›æŠ½<br>
          0ï¼šå›æŠ½å®Œæˆ<br>
          261ï¼šæç¤ºæ’å…¥çº¿æ<br>
          262ï¼šæ’å…¥æˆåŠŸï¼Œæç¤ºè§‚å¯Ÿå–·å˜´<br>
          263ï¼šç¡®è®¤ä¹‹åæŒ¤å‡ºææ–™å¹¶å†²åˆ·<br>
          768ï¼šè¿›æ–™å®Œæˆ<br>
          1280ï¼šæ­£åœ¨æ‰“å°ï¼ˆä¸ç¡®å®šï¼‰">â”</span>:
      </td>
      <td id="ams_status">unknown</td>
    </tr>
    <tr>
      <td>print_error: </td>
      <td id="print_error">unknown</td>
    </tr>
    <tr>
      <td>gcode_state: </td>
      <td id="gcode_state">unknown</td>
    </tr>
    <tr>
      <td>mc_percent: </td>
      <td id="mc_percent">unknown</td>
    </tr>
  </table>
</div>
<!-- https://getbootstrap.com/docs/5.3/components/alerts/ -->
<div id="messages" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>

<script>
  function print(message) {
    let para = document.createElement("div");
    para.setAttribute("class", "alert alert-success alert-dismissible fade show");
    para.appendChild(document.createTextNode(message));
    let button = document.createElement("button");
    button.setAttribute("class", "btn-close");
    button.setAttribute("data-bs-dismiss", "alert");
    para.appendChild(button);
    document.getElementById("messages").appendChild(para);
  }
</script>
<script>
  var websocket;
  function initWebSocket() {
    websocket = new WebSocket(`ws://${window.location.hostname}/ws`);
    websocket.onmessage = onMessage;
    websocket.onopen = onopen;
  }
  function onopen(event) {
    let e = new bootstrap.Collapse('#config');
    e.hide();
  }
  function onMessage(event) {
    console.log('On message:');
    console.log(event.data);
    const data = JSON.parse(event.data);
    for (let k in data) {
      if (k == "message") {
        print(data[k]);
      } else if (k == "ams") {
        console.log(data[k]);
      } else {
        document.getElementById(k).innerText = data[k];
      }
    }
  }

  window.addEventListener('load', onLoad);

  function onLoad(event) {
    initWebSocket();
  }
</script>
  <script>
    // https://bootstrapdoc.com/docs/5.0/components/tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle=tooltip]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  </script>
</html>
