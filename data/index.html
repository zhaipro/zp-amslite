<!DOCTYPE html>
<html>
<meta name="viewport" content='width=device-width;text/html;charset=utf-8' http-equiv="Content-Type" />
<style>
  div.hidden {display:none;}
</style>
<style>
  .tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted black;
  }
  
  .tooltip .tooltiptext {
    visibility: hidden;
    width: 256px;
    background-color: black;
    color: #fff;
    /* text-align: center; */
    border-radius: 6px;
    padding: 5px 10px;

    /* 定位 */
    position: absolute;
    z-index: 1;
  }
  
  .tooltip:hover .tooltiptext {
    visibility: visible;
  }
</style>
<script>
  function do_fetch(pathname, params=null, kws=null) {
    var origin = window.location.origin;
    // https://developer.mozilla.org/zh-CN/docs/Web/API/URL
    if (origin.startsWith('file')) {
      return;
    }
    var url = new URL(pathname, origin);
    if (params == null) {
      params = [];
    }
    for (let i in params) {
      var k = params[i];
      // https://developer.mozilla.org/zh-CN/docs/Web/API/Document/getElementById
      var e = document.getElementById(k);
      if (e == null) {
        e = document.getElementsByName(k)[0];
      }
      var v = e.value;
      // https://code-boxx.com/javascript-fetch-get-query-params/
      url.searchParams.append(k, v);
    }
    if (kws == null) {
      kws = {}
    }
    for (let k in kws) {
      url.searchParams.append(k, kws[k]);
    }
    return fetch(url);
  }

  function unload() {
    do_fetch('/unload', ['previous_extruder'])
  }
  function load() {
    do_fetch('/load', ['next_extruder'])
  }
  function stop() {
    do_fetch('/stop', ['servo1_init', 'servo_power', 'previous_extruder', 'next_extruder'])
  }
  function test_forward() {
    do_fetch('/test_forward', ['next_extruder'])
  }
  function test_backward() {
    do_fetch('/test_backward', ['previous_extruder'])
  }
  function get_config() {
    do_fetch('/get_config')
      .then((response) => response.json())
      .then((data) => {
        for (let k in data) {
          var e = document.getElementsByName(k)[0];
          if (e) {
            e.value = data[k];
            // e.setAttribute('value', data[k]);
          }
        }
      });
  }
  function wifi_begin() {
    do_fetch('/wifi_begin', ['WiFi_ssid', 'WiFi_passphrase'])
  }
  function get_local_ip() {
    do_fetch('/get_local_ip')
      .then((response) => response.json())
      .then((data) => {
        var e = document.getElementById("local_ip");
        e.href = "http://" + data["local_ip"];
        e.text = data["local_ip"];
      })
  }
  function on_load() {
    get_config();
  }
  window.addEventListener('load', on_load);
</script>
<script>
  function mode_change() {
    var mode = document.getElementsByName('mode')[0].value;
    if (mode == "WAN") {
      document.getElementById('LAN').setAttribute("class", "hidden");
      document.getElementById('WAN').setAttribute("class", "");
    } else if (mode == "LAN"){
      document.getElementById('LAN').setAttribute("class", "");
      document.getElementById('WAN').setAttribute("class", "hidden");
    }
  }
</script>

<div style="width:400px;float:left;">

<button onmouseup=get_config()>0. 获取配置信息</button> <br>
WiFi名称：<input name="WiFi_ssid"> <br>
WiFi密码：<input name="WiFi_passphrase"> <br>
<button onmouseup=wifi_begin()>1. 连接 WiFi</button> <br>
<button onmouseup=get_local_ip()>2. 获取 ip</button> <br>
3. 跳转到：<a id="local_ip"></a> <br>
--------------------------------------------------
<form action="/put_config" target="stop">
4. 请选择联机模式: 
<select name="mode" onchange=mode_change()>
  <option value="WAN">广域网模式</option>
  <option value="LAN">局域网模式</option>
</select>
<br>
<div id="LAN" class="hidden">
  打印机ip地址：<input name="bambu_mqtt_broker"> <br>
  打印机访问码：<input name="bambu_mqtt_password"> <br>
</div>
<div id="WAN">
  手机号码：<input name="phone_number"> <br>
  密码：<input name="password"> <br>
</div>
打印机序列号：<input name="bambu_device_serial"> <br>
servo1_init: <input type='number' name='servo1_init' value=90> <br>
servo_power: <input type='number' name='servo_power' value=30> <br>
有待退料管道：<input type='number' name='previous_extruder' value=0> <br>
有待进料管道：<input type='number' name='next_extruder' value=0> <br>
<input type="submit" value="5. 上传配置信息">
</form>
<iframe  name="stop" style="display:none;"></iframe>
<button onmouseup=unload()>unload</button>
<button onmouseup=load()>load</button>
<button onmouseup=stop()>stop</button> <br>
<button onmouseup=fetch('/resume')>resume</button>
<button onmouseup=fetch('/gcode_m109')>gcode_m109</button> <br>
<button onmouseup=test_forward()>test_forward</button>
<button onmouseup=test_backward()>test_backward</button>
</div>

<div style="float:left;">
  <table>
    <tr>
      <td>sequence_id:</td>
      <td id="sequence_id">unknown</td>
    </tr>
    <tr>
      <td>hw_switch_state
        <div class="tooltip">❔
          <span class="tooltiptext">
            料线检测<br>
            1：正常<br>
            0：无料
          </span>
        </div>
        :
      </td>
      <td id="hw_switch_state">unknown</td>
    </tr>
    <tr>
      <td>ams_status
        <div class="tooltip">❔
          <span class="tooltiptext">
            258：加热喷嘴<br>
            259：剪断耗材丝<br>
            260:退料最后提示回抽<br>
            0：回抽完成<br>
            261：提示插入线材<br>
            262：插入成功，提示观察喷嘴<br>
            263：确认之后挤出材料并冲刷<br>
            768：进料完成<br>
            1280：正在打印（不确定）
          </span>
        </div>:
      </td>
      <td id="ams_status">unknown</td>
    </tr>
    <tr>
      <td>print_error: </td>
      <td id="print_error">unknown</td>
    </tr>
    <tr>
      <td>gcode_state: </td>
      <td id="gcode_state">unknown</td>
    </tr>
    <tr>
      <td>mc_percent: </td>
      <td id="mc_percent">unknown</td>
    </tr>
  </table>
</div>
<script>
  var gateway = `ws://${window.location.hostname}/ws`;
  var websocket;
  function initWebSocket() {
    console.log('Trying to open a WebSocket connection...');
    websocket = new WebSocket(gateway);
    websocket.onopen    = onOpen;
    websocket.onclose   = onClose;
    websocket.onmessage = onMessage;
  }
  function onOpen(event) {
    console.log('Connection opened');
  }
  function onClose(event) {
    console.log('Connection closed');
  }
  function onMessage(event) {
    console.log('On message:');
    console.log(event.data);
    const data = JSON.parse(event.data);
    for (let k in data) {
      document.getElementById(k).innerText = data[k];
    }
  }

  window.addEventListener('load', onLoad);

  function onLoad(event) {
    initWebSocket();
  }
</script>
</html>
